# install docker-compose on friendlywrt

# see if any updates here - this version is 2021-07-14
# source: https://gist.github.com/CRFSlick/ba518c3f2c83caba6865b17c52a4a62a

# -----------------------------------------------------------------------

# Script to install 'docker-compose' on an OpenWrt platform, in this case FriendlyWrt
# Written by CRFSlick <3

# Update package manager
opkg update

# Install python3 and tools (including GNU grep)
# https://forum.openwrt.org/t/grep-that-handles-long-lines/31096
opkg install python3 python3-dev python3-pip python3-cffi python3-cffi-src autoconf make grep gcc

# Update pip and install wheel
# python3 -m pip install --upgrade pip
pip3 install --upgrade pip
pip3 install wheel

# Install library headers manually as OpenWRT does not have dev packages for required libs (libffi-dev and libssl-dev)
# https://github.com/Entware/Entware/issues/549

# libffi
wget -O /usr/include/ffitarget.h https://raw.githubusercontent.com/KxSystems/ffi/master/travis_win/libffi/install/include/ffitarget.h
wget -O /usr/include/ffi.h https://raw.githubusercontent.com/KxSystems/ffi/master/travis_win/libffi/install/include/ffi.h
ln -s /usr/lib/libffi.so.7 /usr/lib/libffi.so

# libssl
git clone https://github.com/OneSignal/openssl /tmp/openssl
mkdir /usr/include/openssl
cp /tmp/openssl/include/openssl/* /usr/include/openssl/
ln -s /usr/lib/libssl.so.1.1 /usr/lib/libssl.so
ln -s /usr/lib/libcrypto.so.1.1 /usr/lib/libcrypto.so

# Include required 'opensslconf.h' file that should be made by the package manager
opensslconf='LyoKICogV0FSTklORzogZG8gbm90IGVkaXQhCiAqIEdlbmVyYXRlZCBieSBNYWtlZmlsZSBmcm9tIC4uL2luY2x1ZGUvb3BlbnNzbC9vcGVuc3NsY29uZi5oLmluCiAqCiAqIENvcHlyaWdodCAyMDE2LTIwMjAgVGhlIE9wZW5TU0wgUHJvamVjdCBBdXRob3JzLiBBbGwgUmlnaHRzIFJlc2VydmVkLgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgT3BlblNTTCBsaWNlbnNlICh0aGUgIkxpY2Vuc2UiKS4gIFlvdSBtYXkgbm90IHVzZQogKiB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS4gIFlvdSBjYW4gb2J0YWluIGEgY29weQogKiBpbiB0aGUgZmlsZSBMSUNFTlNFIGluIHRoZSBzb3VyY2UgZGlzdHJpYnV0aW9uIG9yIGF0CiAqIGh0dHBzOi8vd3d3Lm9wZW5zc2wub3JnL3NvdXJjZS9saWNlbnNlLmh0bWwKICovCgojaW5jbHVkZSA8b3BlbnNzbC9vcGVuc3Nsdi5oPgoKI2lmZGVmICBfX2NwbHVzcGx1cwpleHRlcm4gIkMiIHsKI2VuZGlmCgojaWZkZWYgT1BFTlNTTF9BTEdPUklUSE1fREVGSU5FUwojIGVycm9yIE9QRU5TU0xfQUxHT1JJVEhNX0RFRklORVMgbm8gbG9uZ2VyIHN1cHBvcnRlZAojZW5kaWYKCi8qCiAqIE9wZW5TU0wgd2FzIGNvbmZpZ3VyZWQgd2l0aCB0aGUgZm9sbG93aW5nIG9wdGlvbnM6CiAqLwoKI2lmbmRlZiBPUEVOU1NMX05PX0lERUEKIyBkZWZpbmUgT1BFTlNTTF9OT19JREVBCiNlbmRpZgojaWZuZGVmIE9QRU5TU0xfTk9fTUQyCiMgZGVmaW5lIE9QRU5TU0xfTk9fTUQyCiNlbmRpZgojaWZuZGVmIE9QRU5TU0xfTk9fTURDMgojIGRlZmluZSBPUEVOU1NMX05PX01EQzIKI2VuZGlmCiNpZm5kZWYgT1BFTlNTTF9OT19SQzUKIyBkZWZpbmUgT1BFTlNTTF9OT19SQzUKI2VuZGlmCiNpZm5kZWYgT1BFTlNTTF9USFJFQURTCiMgZGVmaW5lIE9QRU5TU0xfVEhSRUFEUwojZW5kaWYKI2lmbmRlZiBPUEVOU1NMX1JBTkRfU0VFRF9PUwojIGRlZmluZSBPUEVOU1NMX1JBTkRfU0VFRF9PUwojZW5kaWYKI2lmbmRlZiBPUEVOU1NMX05PX0FTQU4KIyBkZWZpbmUgT1BFTlNTTF9OT19BU0FOCiNlbmRpZgojaWZuZGVmIE9QRU5TU0xfTk9fQ0FQSUVORwojIGRlZmluZSBPUEVOU1NMX05PX0NBUElFTkcKI2VuZGlmCiNpZm5kZWYgT1BFTlNTTF9OT19DUllQVE9fTURFQlVHCiMgZGVmaW5lIE9QRU5TU0xfTk9fQ1JZUFRPX01ERUJVRwojZW5kaWYKI2lmbmRlZiBPUEVOU1NMX05PX0NSWVBUT19NREVCVUdfQkFDS1RSQUNFCiMgZGVmaW5lIE9QRU5TU0xfTk9fQ1JZUFRPX01ERUJVR19CQUNLVFJBQ0UKI2VuZGlmCiNpZm5kZWYgT1BFTlNTTF9OT19ERVZDUllQVE9FTkcKIyBkZWZpbmUgT1BFTlNTTF9OT19ERVZDUllQVE9FTkcKI2VuZGlmCiNpZm5kZWYgT1BFTlNTTF9OT19FR0QKIyBkZWZpbmUgT1BFTlNTTF9OT19FR0QKI2VuZGlmCiNpZm5kZWYgT1BFTlNTTF9OT19FWFRFUk5BTF9URVNUUwojIGRlZmluZSBPUEVOU1NMX05PX0VYVEVSTkFMX1RFU1RTCiNlbmRpZgojaWZuZGVmIE9QRU5TU0xfTk9fRlVaWl9BRkwKIyBkZWZpbmUgT1BFTlNTTF9OT19GVVpaX0FGTAojZW5kaWYKI2lmbmRlZiBPUEVOU1NMX05PX0ZVWlpfTElCRlVaWkVSCiMgZGVmaW5lIE9QRU5TU0xfTk9fRlVaWl9MSUJGVVpaRVIKI2VuZGlmCiNpZm5kZWYgT1BFTlNTTF9OT19IRUFSVEJFQVRTCiMgZGVmaW5lIE9QRU5TU0xfTk9fSEVBUlRCRUFUUwojZW5kaWYKI2lmbmRlZiBPUEVOU1NMX05PX01TQU4KIyBkZWZpbmUgT1BFTlNTTF9OT19NU0FOCiNlbmRpZgojaWZuZGVmIE9QRU5TU0xfTk9fU0NUUAojIGRlZmluZSBPUEVOU1NMX05PX1NDVFAKI2VuZGlmCiNpZm5kZWYgT1BFTlNTTF9OT19TU0xfVFJBQ0UKIyBkZWZpbmUgT1BFTlNTTF9OT19TU0xfVFJBQ0UKI2VuZGlmCiNpZm5kZWYgT1BFTlNTTF9OT19TU0wzCiMgZGVmaW5lIE9QRU5TU0xfTk9fU1NMMwojZW5kaWYKI2lmbmRlZiBPUEVOU1NMX05PX1NTTDNfTUVUSE9ECiMgZGVmaW5lIE9QRU5TU0xfTk9fU1NMM19NRVRIT0QKI2VuZGlmCiNpZm5kZWYgT1BFTlNTTF9OT19VQlNBTgojIGRlZmluZSBPUEVOU1NMX05PX1VCU0FOCiNlbmRpZgojaWZuZGVmIE9QRU5TU0xfTk9fV0VBS19TU0xfQ0lQSEVSUwojIGRlZmluZSBPUEVOU1NMX05PX1dFQUtfU1NMX0NJUEhFUlMKI2VuZGlmCiNpZm5kZWYgT1BFTlNTTF9OT19TVEFUSUNfRU5HSU5FCiMgZGVmaW5lIE9QRU5TU0xfTk9fU1RBVElDX0VOR0lORQojZW5kaWYKCgovKgogKiBTb21ldGltZXMgT1BFTlNTU0xfTk9feHh4IGVuZHMgdXAgd2l0aCBhbiBlbXB0eSBmaWxlIGFuZCBzb21lIGNvbXBpbGVycwogKiBkb24ndCBsaWtlIHRoYXQuICBUaGlzIHdpbGwgaG9wZWZ1bGx5IHNpbGVuY2UgdGhlbS4KICovCiNkZWZpbmUgTk9OX0VNUFRZX1RSQU5TTEFUSU9OX1VOSVQgc3RhdGljIHZvaWQgKmR1bW15ID0gJmR1bW15OwoKLyoKICogQXBwbGljYXRpb25zIHNob3VsZCB1c2UgLURPUEVOU1NMX0FQSV9DT01QQVQ9PHZlcnNpb24+IHRvIHN1cHByZXNzIHRoZQogKiBkZWNsYXJhdGlvbnMgb2YgZnVuY3Rpb25zIGRlcHJlY2F0ZWQgaW4gb3IgYmVmb3JlIDx2ZXJzaW9uPi4gT3RoZXJ3aXNlLCB0aGV5CiAqIHN0aWxsIHdvbid0IHNlZSB0aGVtIGlmIHRoZSBsaWJyYXJ5IGhhcyBiZWVuIGJ1aWx0IHRvIGRpc2FibGUgZGVwcmVjYXRlZAogKiBmdW5jdGlvbnMuCiAqLwojaWZuZGVmIERFQ0xBUkVfREVQUkVDQVRFRAojIGRlZmluZSBERUNMQVJFX0RFUFJFQ0FURUQoZikgICBmOwojIGlmZGVmIF9fR05VQ19fCiMgIGlmIF9fR05VQ19fID4gMyB8fCAoX19HTlVDX18gPT0gMyAmJiBfX0dOVUNfTUlOT1JfXyA+IDApCiMgICB1bmRlZiBERUNMQVJFX0RFUFJFQ0FURUQKIyAgIGRlZmluZSBERUNMQVJFX0RFUFJFQ0FURUQoZikgICAgZiBfX2F0dHJpYnV0ZV9fICgoZGVwcmVjYXRlZCkpOwojICBlbmRpZgojIGVsaWYgZGVmaW5lZChfX1NVTlBST19DKQojICBpZiAoX19TVU5QUk9fQyA+PSAweDUxMzApCiMgICB1bmRlZiBERUNMQVJFX0RFUFJFQ0FURUQKIyAgIGRlZmluZSBERUNMQVJFX0RFUFJFQ0FURUQoZikgICAgZiBfX2F0dHJpYnV0ZV9fICgoZGVwcmVjYXRlZCkpOwojICBlbmRpZgojIGVuZGlmCiNlbmRpZgoKI2lmbmRlZiBPUEVOU1NMX0ZJTEUKIyBpZmRlZiBPUEVOU1NMX05PX0ZJTEVOQU1FUwojICBkZWZpbmUgT1BFTlNTTF9GSUxFICIiCiMgIGRlZmluZSBPUEVOU1NMX0xJTkUgMAojIGVsc2UKIyAgZGVmaW5lIE9QRU5TU0xfRklMRSBfX0ZJTEVfXwojICBkZWZpbmUgT1BFTlNTTF9MSU5FIF9fTElORV9fCiMgZW5kaWYKI2VuZGlmCgojaWZuZGVmIE9QRU5TU0xfTUlOX0FQSQojIGRlZmluZSBPUEVOU1NMX01JTl9BUEkgMAojZW5kaWYKCiNpZiAhZGVmaW5lZChPUEVOU1NMX0FQSV9DT01QQVQpIHx8IE9QRU5TU0xfQVBJX0NPTVBBVCA8IE9QRU5TU0xfTUlOX0FQSQojIHVuZGVmIE9QRU5TU0xfQVBJX0NPTVBBVAojIGRlZmluZSBPUEVOU1NMX0FQSV9DT01QQVQgT1BFTlNTTF9NSU5fQVBJCiNlbmRpZgoKLyoKICogRG8gbm90IGRlcHJlY2F0ZSB0aGluZ3MgdG8gYmUgZGVwcmVjYXRlZCBpbiB2ZXJzaW9uIDEuMi4wIGJlZm9yZSB0aGUKICogT3BlblNTTCB2ZXJzaW9uIG51bWJlciBtYXRjaGVzLgogKi8KI2lmIE9QRU5TU0xfVkVSU0lPTl9OVU1CRVIgPCAweDEwMjAwMDAwTAojIGRlZmluZSBERVBSRUNBVEVESU5fMV8yXzAoZikgICBmOwojZWxpZiBPUEVOU1NMX0FQSV9DT01QQVQgPCAweDEwMjAwMDAwTAojIGRlZmluZSBERVBSRUNBVEVESU5fMV8yXzAoZikgICBERUNMQVJFX0RFUFJFQ0FURUQoZikKI2Vsc2UKIyBkZWZpbmUgREVQUkVDQVRFRElOXzFfMl8wKGYpCiNlbmRpZgoKI2lmIE9QRU5TU0xfQVBJX0NPTVBBVCA8IDB4MTAxMDAwMDBMCiMgZGVmaW5lIERFUFJFQ0FURURJTl8xXzFfMChmKSAgIERFQ0xBUkVfREVQUkVDQVRFRChmKQojZWxzZQojIGRlZmluZSBERVBSRUNBVEVESU5fMV8xXzAoZikKI2VuZGlmCgojaWYgT1BFTlNTTF9BUElfQ09NUEFUIDwgMHgxMDAwMDAwMEwKIyBkZWZpbmUgREVQUkVDQVRFRElOXzFfMF8wKGYpICAgREVDTEFSRV9ERVBSRUNBVEVEKGYpCiNlbHNlCiMgZGVmaW5lIERFUFJFQ0FURURJTl8xXzBfMChmKQojZW5kaWYKCiNpZiBPUEVOU1NMX0FQSV9DT01QQVQgPCAweDAwOTA4MDAwTAojIGRlZmluZSBERVBSRUNBVEVESU5fMF85XzgoZikgICBERUNMQVJFX0RFUFJFQ0FURUQoZikKI2Vsc2UKIyBkZWZpbmUgREVQUkVDQVRFRElOXzBfOV84KGYpCiNlbmRpZgoKLyogR2VuZXJhdGUgODAzODYgY29kZT8gKi8KI3VuZGVmIEkzODZfT05MWQoKI3VuZGVmIE9QRU5TU0xfVU5JU1RECiNkZWZpbmUgT1BFTlNTTF9VTklTVEQgPHVuaXN0ZC5oPgoKI3VuZGVmIE9QRU5TU0xfRVhQT1JUX1ZBUl9BU19GVU5DVElPTgoKLyoKICogVGhlIGZvbGxvd2luZyBhcmUgY2lwaGVyLXNwZWNpZmljLCBidXQgYXJlIHBhcnQgb2YgdGhlIHB1YmxpYyBBUEkuCiAqLwojaWYgIWRlZmluZWQoT1BFTlNTTF9TWVNfVUVGSSkKIyB1bmRlZiBCTl9MTE9ORwovKiBPbmx5IG9uZSBmb3IgdGhlIGZvbGxvd2luZyBzaG91bGQgYmUgZGVmaW5lZCAqLwojIGRlZmluZSBTSVhUWV9GT1VSX0JJVF9MT05HCiMgdW5kZWYgU0lYVFlfRk9VUl9CSVQKIyB1bmRlZiBUSElSVFlfVFdPX0JJVAojZW5kaWYKCiNkZWZpbmUgUkM0X0lOVCB1bnNpZ25lZCBpbnQKCiNpZmRlZiAgX19jcGx1c3BsdXMKfQojZW5kaWYK'
echo $opensslconf | base64 -d > /usr/include/openssl/opensslconf.h

# Install pip cryptography v2.8 to avoid needing a rust compiler
pip3 install -Iv cryptography==2.8

# Install docker-compose
pip3 install docker-compose

echo 'Done!'