#!/bin/bash

# run ladder99 pipeline using prebuilt images from docker hub.

usage="
Usage: l99 start CLIENT [SERVICES]

Run the Ladder99 pipeline with a list of services/profiles to include.

SERVICES      space-delim list of services or profiles to start
  base        run all relevant services for a setup - eg adapter, agent, etc.
              (this is the default)

Examples
    l99 start oxbox agent
    l99 start oxbox
"

# show help
# if [ $# -eq 0 ]; then
if [ "$1" = "-h" ]; then
    echo "$usage"
    exit
fi

# get setup folder
SETUP=$1
shift
SETUP_FOLDER=../client-$SETUP
SETUP=$SETUP_FOLDER

# if no services specified, default to 'base', which should run the main services
SERVICES=${*:-base}

# file paths
COMPOSE=services/compose.yaml
COMPOSE_PROD=services/compose.prod.yaml
OVERRIDES=$SETUP_FOLDER/compose-overrides.yaml
ENVFILE=$SETUP_FOLDER/.env
ENVFILE_EXAMPLE=$SETUP_FOLDER/.env-example

# specify docker compose files
FILES="--file $COMPOSE --file $COMPOSE_PROD"
if [ -e $OVERRIDES ]; then
    FILES="$FILES --file $OVERRIDES"
fi

# add environment variable file
ENVFILES=""
if [ -e $ENVFILE ]; then
    # use .env file if there
    ENVFILES="$ENVFILES --env-file $ENVFILE"
else
    # otherwise create a new .env file and stop
    echo "No .env file found - copying from default..."
    cp $ENVFILE_EXAMPLE $ENVFILE
    echo
    echo "PLEASE SET INITIAL PASSWORDS IN .env FILE -"
    echo "For example, run 'nano $ENVFILE', set the Grafana and Postgres passwords,"
    echo "then re-run the 'l99 start' command."
    echo
    exit 1
fi

# get profile flags - one per service/profile specified
PROFILE_FLAGS=""
for PROFILE in $SERVICES; do
    PROFILE_FLAGS="$PROFILE_FLAGS --profile $PROFILE"
done

# make cmd and run it
CMD="export SETUP=$SETUP && \
docker compose \
    $FILES $ENVFILES $PROFILE_FLAGS \
    pull && \
docker compose \
    $FILES $ENVFILES $PROFILE_FLAGS \
    up --no-build --detach"

echo "$CMD"
bash -c "$CMD"

echo
echo "Run './list' to check status of services."
