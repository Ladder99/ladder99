# docker-compose file for broker-adapter-agent pipeline.
# these services are run in addition to those in setups/compose.yaml.

#. this will be generated from devices.yaml, but edit manually for now.

version: '3.8'

services:
  # mtconnect agent
  # this overrides settings from setups/compose.yaml
  agent:
    command: agent debug /data/agent/agent.cfg
    volumes:
      - ./$SETUP/volumes/agent:/data/agent # has agent.cfg, devices.xml

  # mqtt broker
  # gets mqtt data from devices and publishes it to mtconnect adapter.
  # we can playback mqtt data through this to simulate a device.
  broker:
    container_name: broker
    image: eclipse-mosquitto
    ports:
      - 1883:1883
    volumes:
      - ./$SETUP/volumes/broker:/mosquitto # has config/mosquitto.conf
    networks:
      - ladder99
    logging:
      options:
        max-size: '1m'

  # mtconnect adapter
  # converts machine data to shdr and sends to mtconnect agent
  adapter:
    container_name: adapter
    image: node:15.14-slim
    user: node
    working_dir: /home/node/app
    command: npm start
    volumes:
      - ../services/adapter:/home/node/app # has source code
      - ./$SETUP:/data/adapter # has devices.yaml
      - ../models:/data/models # has model yamls
    networks:
      - ladder99
    logging:
      options:
        max-size: '1m'

  # play mqtt recordings
  #. use tape app separately? put here? i guess put here
  play:
    container_name: play
    build: ../services/tape
    profiles:
      - play
    command: tape --host broker --folder ./models/pa/tape
    # environment:
    #   - HOST=broker
    #   - PORT=1883
    #   - FOLDER=../models/pa/tape
    #   - LOOP=true
    volumes:
      - ../services/replay:/etc/tape # contains csv files
    networks:
      - ladder99
    logging:
      options:
        max-size: '1m'

  #. move into tape also - have plugins for diff datasources?

  # sim-opc:
  #   container_name: sim-opc
  #   image: node:15.14-slim
  #   user: node
  #   working_dir: /home/node/app
  #   command: npm start
  #   volumes:
  #     - ../../../services/sim-opc:/home/node/app
  #   networks:
  #     - ladder99
  #   logging:
  #     options:
  #       max-size: '1m'

networks:
  ladder99:
    name: ladder99
