# docker-compose file for broker-adapter-agent pipeline.
#. this will be generated from devices.yaml, but edit manually for now.

version: '3.8'

services:
  # override agent settings from main compose.yaml
  agent:
    command: agent debug /data/agent/agent.cfg
    volumes:
      # contains agent.cfg and devices.xml
      - ./$SETUP/volumes/agent:/data/agent

  broker:
    container_name: broker
    image: eclipse-mosquitto
    ports:
      - 1883:1883
    volumes:
      # contains config/mosquitto.conf
      - ./$SETUP/volumes/broker:/mosquitto
    networks:
      - ladder99
    logging:
      options:
        max-size: '1m'

  adapter:
    container_name: adapter
    image: node:15.14
    user: node
    working_dir: /home/node/app
    command: npm start
    volumes:
      # contains source code
      - ../services/adapter:/home/node/app
      # contains devices.yaml
      - ./$SETUP:/data/adapter
      # contains model yamls
      - ../models:/data/models
    networks:
      - ladder99
    logging:
      options:
        max-size: '1m'

  simulator-mqtt:
    container_name: simulator-mqtt
    image: node:15
    user: node
    working_dir: /home/node/app
    command: npm start
    environment:
      - MQTT_HOST=broker
      - MQTT_PORT=1883
      - DEVICE_ID=ccs-pa-001
      - MESSAGES_FILE=/etc/simulator-mqtt/messages.js
      - MESSAGE_DELAY=1000
      - LOOP=true
      - LOOP_DELAY=3000
    volumes:
      # contains source code
      - ../services/simulator-mqtt:/home/node/app
      # contains simulation messages
      - ./$SETUP/volumes/simulator-mqtt:/etc/simulator-mqtt
    networks:
      - ladder99
    logging:
      options:
        max-size: '1m'

  # simulator-opc:
  #   container_name: simulator-opc
  #   image: node:15
  #   user: node
  #   working_dir: /home/node/app
  #   command: npm start
  #   volumes:
  #     - ../../../services/simulator-opc:/home/node/app
  #   networks:
  #     - ladder99
  #   logging:
  #     options:
  #       max-size: '1m'

networks:
  ladder99:
    name: ladder99
