# docker-compose file for broker-adapter-agent pipeline.
# these services are run in addition to those in setups/compose.yaml.

#. this will be generated from devices.yaml, but edit manually for now.

version: '3.8'

services:
  # mtconnect agent
  # this overrides settings from setups/compose.yaml
  agent:
    command: agent debug /data/agent/agent.cfg
    volumes:
      - ./$SETUP/volumes/agent:/data/agent # has agent.cfg, devices.xml

  # mqtt broker
  # gets data from devices and publishes it to mtconnect adapter
  broker:
    container_name: broker
    image: eclipse-mosquitto
    ports:
      - 1883:1883
    volumes:
      - ./$SETUP/volumes/broker:/mosquitto # has config/mosquitto.conf
    networks:
      - ladder99
    logging:
      options:
        max-size: '1m'

  # mtconnect adapter
  # converts machine data to shdr and sends to mtconnect agent
  adapter:
    container_name: adapter
    image: node:15.14-slim
    user: node
    working_dir: /home/node/app
    command: npm start
    volumes:
      - ../services/adapter:/home/node/app # has source code
      - ./$SETUP:/data/adapter # has devices.yaml
      - ../models:/data/models # has model yamls
    networks:
      - ladder99
    logging:
      options:
        max-size: '1m'

  # record mqtt recordings
  record-mqtt:
    container_name: record-mqtt
    build: ../services/sim-mqtt
    profiles:
      - record-mqtt
    environment:
      - MQTT_HOST=broker
      - MQTT_PORT=1883
      - DEVICE_ID=ccs-pa-001
      - MODEL=ccs-pa
      - MODELS_FOLDER=/etc/models
      - LOOP=true
      - LOOP_DELAY=3000
    volumes:
      - ../services/replay:/data/app # has source code
      - ../models:/etc/models # has MODEL/simulations subfolder with sim msgs
    networks:
      - ladder99
    logging:
      options:
        max-size: '1m'

  # play mqtt recordings
  play-mqtt:
    container_name: play-mqtt
    build: ../services/sim-mqtt
    profiles:
      - play-mqtt
    environment:
      - MQTT_HOST=broker
      - MQTT_PORT=1883
      - DEVICE_ID=ccs-pa-001
      - MODEL=ccs-pa
      - MODELS_FOLDER=/etc/models
      - LOOP=true
      - LOOP_DELAY=3000
    volumes:
      - ../services/replay:/data/app # has source code
      - ../models:/etc/models # has MODEL/simulations subfolder with sim msgs
    networks:
      - ladder99
    logging:
      options:
        max-size: '1m'

  # sim-mqtt:
  #   container_name: sim-mqtt
  #   image: node:15.14-slim
  #   user: node
  #   working_dir: /home/node/app
  #   command: npm start
  #   environment:
  #     - MQTT_HOST=broker
  #     - MQTT_PORT=1883
  #     - DEVICE_ID=ccs-pa-001
  #     - MESSAGES_FILE=/etc/sim-mqtt/messages.js
  #     - MESSAGE_DELAY=1000
  #     - LOOP=true
  #     - LOOP_DELAY=3000
  #   volumes:
  #     - ../services/sim-mqtt:/home/node/app # has source code
  #     - ./$SETUP/volumes/sim-mqtt:/etc/sim-mqtt # has sim msgs
  #   networks:
  #     - ladder99
  #   logging:
  #     options:
  #       max-size: '1m'

  # sim-opc:
  #   container_name: sim-opc
  #   image: node:15.14-slim
  #   user: node
  #   working_dir: /home/node/app
  #   command: npm start
  #   volumes:
  #     - ../../../services/sim-opc:/home/node/app
  #   networks:
  #     - ladder99
  #   logging:
  #     options:
  #       max-size: '1m'

networks:
  ladder99:
    name: ladder99
